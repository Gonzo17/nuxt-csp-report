name: ci

permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  resolve-versions:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.nuxt.outputs.matrix }}

    steps:
      - uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Resolve Nuxt versions
        id: nuxt
        run: |
          VERSIONS=$(npm view nuxt versions --json)
          VERSIONS="$VERSIONS" node - <<'NODE' >> "$GITHUB_OUTPUT"
          const versions = JSON.parse(process.env.VERSIONS)
          const semverGte = (a, b) => {
            const pa = a.split('.').map(Number)
            const pb = b.split('.').map(Number)
            for (let i = 0; i < 3; i++) {
              if ((pa[i] || 0) > (pb[i] || 0)) return true
              if ((pa[i] || 0) < (pb[i] || 0)) return false
            }
            return true
          }
          const pick = (major, minVersion, count) =>
            versions
              .filter(v => v.startsWith(`${major}.`) && semverGte(v, minVersion))
              .slice(-count)

          const nuxt = [
            ...pick(3, '3.7.0', 5), // writeTypes is available from Nuxt 3.7+
            ...pick(4, '0.0.0', 5),
          ]

          console.log(`matrix=${JSON.stringify({ nuxt })}`)
          NODE

  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 20

      - run: npm i -g --force corepack@latest && corepack enable

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: pnpm lint

  test:
    name: Test (Nuxt ${{ matrix.nuxt }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.resolve-versions.outputs.matrix) }}
    needs: resolve-versions

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v6
        with:
          node-version: 20

      - run: npm i -g --force corepack@latest && corepack enable

      - name: Set Nuxt version
        run: |
          pnpm pkg set devDependencies.nuxt=${{ matrix.nuxt }}
          pnpm pkg set dependencies.@nuxt/kit=${{ matrix.nuxt }}
          pnpm pkg set devDependencies.@nuxt/schema=${{ matrix.nuxt }}
          echo "Selected Nuxt version: ${{ matrix.nuxt }}"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Show installed Nuxt version
        run: node -e "['nuxt','@nuxt/kit','@nuxt/schema'].forEach(p=>console.log(p+':',require(p+'/package.json').version))"

      - name: Playground prepare
        run: pnpm dev:prepare

      - name: Test
        run: pnpm test
